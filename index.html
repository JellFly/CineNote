<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anime Tracker - Accueil</title>
    <link rel="stylesheet" href="style.css">
</head>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDWbsbfnF5e-E3rCMguVFF69PpAM-ZlAZ4",
  authDomain: "anime-lo.firebaseapp.com",
  projectId: "anime-lo",
  storageBucket: "anime-lo.firebasestorage.app",
  messagingSenderId: "424542474390",
  appId: "1:424542474390:web:2c28714a4c4f0178daf2b7"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

window.auth = auth;
window.db = db;

window.register = async function(email, password) {
  try {
    await createUserWithEmailAndPassword(auth, email, password);
    try {
      await setDoc(doc(db, "users", auth.currentUser.uid), {
        profiles: [{
          name: "Profil 1",
          avatar: "https://via.placeholder.com/100",
          bio: "",
          animes: [],
          films: [],
          series: [],
          watch: []
        }],
        currentProfileIndex: 0
      });
    } catch(dbError) {
      console.log("Firebase Firestore indisponible, utilisation du stockage local");
      localStorage.setItem("profiles", JSON.stringify([{
        name: "Profil 1",
        avatar: "https://via.placeholder.com/100",
        bio: "",
        animes: [],
        films: [],
        series: [],
        watch: []
      }]));
      localStorage.setItem("currentProfileIndex", "0");
    }
    alert("Compte cr√©√© ! Veuillez compl√©ter votre profil.");
    window.closeAuthModal();
    window.location.href = "profile-setup.html";
  } catch(e) {
    alert("Erreur: " + e.message);
  }
};

window.login = async function(email, password) {
  try {
    await signInWithEmailAndPassword(auth, email, password);
    alert("Connect√© !");
    window.closeAuthModal();
    if(window.loadProfilesFromFirebase) window.loadProfilesFromFirebase();
  } catch(e) {
    alert("Erreur: " + e.message);
  }
};

window.logout = async function() {
  try {
    await signOut(auth);
    alert("D√©connect√©");
    window.updateAuthIcon();
  } catch(e) {
    alert("Erreur: " + e.message);
  }
};

window.loadUserData = async function() {
  if(!auth.currentUser) {
    console.log("Utilisateur non connect√©");
    return;
  }
  try {
    const ref = doc(db, "users", auth.currentUser.uid);
    const snap = await getDoc(ref);
    if(snap.exists()) {
      window.userDataFromFirebase = snap.data();
      console.log("Donn√©es charg√©es:", window.userDataFromFirebase);
      if(window.loadProfilesFromFirebase) window.loadProfilesFromFirebase();
    }
  } catch(e) {
    console.error("Erreur chargement:", e);
  }
};

onAuthStateChanged(auth, (user) => {
  if(user) {
    console.log("Utilisateur connect√©:", user.email);
    window.loadUserData();
    window.updateAuthIcon();
  } else {
    console.log("Utilisateur d√©connect√©");
    window.updateAuthIcon();
    // Charger les profils locaux si non connect√©
    setTimeout(() => {
      if(window.loadProfilesFromFirebase) {
        window.loadProfilesFromFirebase();
      }
    }, 500);
  }
});
</script>

<body>

<header>
    <div>
        <h1>üé¨ Anime Tracker</h1>
    </div>
    <nav>
        <a href="index.html">Accueil</a>
        <a href="add.html">Ajouter</a>
        <a href="list.html">Ma Biblioth√®que</a>
        <a href="watchlist.html">‚è≥ Watchlist</a>
        <a href="about.html">√Ä propos</a>
    </nav>
    <div class="header-right">
        <div class="auth-icon" onclick="window.toggleAuthOrProfile()" id="authIcon">üë§</div>
    </div>
</header>

<!-- Profile Modal -->
<div class="modal" id="profileModal">
    <div class="modal-content" style="max-width: 500px;">
        <button class="modal-close" onclick="window.closeProfileModal()">&times;</button>
        <h2>üë§ Mon Profil</h2>
        
        <div style="text-align: center; margin: 30px 0;">
            <img id="profileModalAvatar" src="" alt="Avatar" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary);">
            <h3 id="profileModalName" style="margin-top: 16px; margin-bottom: 8px;">Nom</h3>
            <p id="profileModalEmail" style="color: var(--text-muted); margin-bottom: 16px;">email@example.com</p>
            <p id="profileModalBio" style="color: var(--text-muted); font-style: italic; margin-bottom: 20px;">Bio</p>
        </div>
        
        <button class="btn-secondary" onclick="window.logout()" style="width: 100%; margin-bottom: 12px;">üö™ Se d√©connecter</button>
        <button class="btn-secondary" onclick="window.closeProfileModal()" style="width: 100%;">Fermer</button>
    </div>
</div>

<!-- Auth Modal -->
<div class="modal" id="authModal">
    <div class="modal-content">
        <button class="modal-close" onclick="window.closeAuthModal()">&times;</button>
        <h2 id="authTitle">Se connecter</h2>
        <div style="display: flex; gap: 12px; margin-bottom: 20px;">
            <button class="tab-btn active" onclick="window.switchAuthTab('login')" style="flex: 1;">Connexion</button>
            <button class="tab-btn" onclick="window.switchAuthTab('register')" style="flex: 1;">Inscription</button>
        </div>
        <div id="loginForm">
            <input id="email" type="email" placeholder="Email" style="margin-bottom: 12px;">
            <input id="pass" type="password" placeholder="Mot de passe" style="margin-bottom: 12px;">
            <button class="btn-primary" onclick="window.login(document.getElementById('email').value, document.getElementById('pass').value)">Se connecter</button>
        </div>
        <div id="registerForm" style="display: none;">
            <input id="emailReg" type="email" placeholder="Email" style="margin-bottom: 12px;">
            <input id="passReg" type="password" placeholder="Mot de passe" style="margin-bottom: 12px;">
            <input id="passRegConfirm" type="password" placeholder="Confirmer le mot de passe" style="margin-bottom: 12px;">
            <button class="btn-primary" onclick="window.register(document.getElementById('emailReg').value, document.getElementById('passReg').value)">Cr√©er un compte</button>
        </div>
    </div>
</div>

<main>
<section class="text-center">
    <h2>üëã Bienvenue dans Anime Tracker</h2>
    <p style="color: var(--text-muted); font-size: 16px; margin: 16px 0;">Organisez et suivez vos anim√©s, films et s√©ries pr√©f√©r√©s</p>
    
    <div class="stats">
        <div class="stat-box">
            <div class="stat-label">Anim√©s regard√©s</div>
            <div class="stat-number" id="statTotal">0</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">Films regard√©s</div>
            <div class="stat-number" id="statFilms">0</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">S√©ries regard√©es</div>
            <div class="stat-number" id="statSeries">0</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">Watchlist</div>
            <div class="stat-number" id="statWatch">0</div>
        </div>
    </div>

    <div class="stats" style="margin-top: 30px;">
        <div class="stat-box">
            <div class="stat-label">Total regard√©</div>
            <div class="stat-number" id="statGrandTotal">0</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">Note moyenne</div>
            <div class="stat-number" id="statAvgRating">0‚≠ê</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">Meilleure note</div>
            <div class="stat-number" id="statBestRating">0‚≠ê</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">Avec avis</div>
            <div class="stat-number" id="statWithComments">0</div>
        </div>
    </div>
</section>
</main>

<script src="site.js"></script>

</body>
</html>
